(function(a){a.fn.extend({mention:function(k){this.opts={users:[],delimiter:"@",delimiters:"",sensitive:true,emptyQuery:false,key:"username",name:"name",image:"image",queryBy:[],typeaheadOpts:{}};var d=a.extend({},this.opts,k),c=function(){if(typeof a=="undefined"){throw new Error("jQuery is Required")}else{if(typeof a.fn.typeahead=="undefined"){throw new Error("Typeahead is Required")}}return true},b=function(n,l){for(var m=l;m>=0;m--){if(n[m]==d.delimiter){break}}return n.substring(m,l)},f=function(n){if(d.queryBy.length==0){d.queryBy=[d.key]}var t=(n.delimiter?n.delimiter:d.delimiter),m=n[d.key].toLowerCase(),l=(this.query.toLowerCase()),u=this.$element[0].selectionStart,v=l.slice(u-1,u);var s=(l.toLowerCase().match(new RegExp(t+"\\w+","g"))||[]).map(function(i){return i.toLowerCase()});var l=(l.substring(0,u).match(new RegExp("([^ "+d.delimiters+"]+)$"))||[""])[0];if(d.emptyQuery){if(v==t){if(s.indexOf(t+m)==-1){return true}}}if(l==""){return false}for(var r in d.queryBy){if(n[d.queryBy[r]]){var x=n[d.queryBy[r]].toLowerCase();if(l.trim().toLowerCase().substring(1)==n[d.key].toLowerCase()){return false}for(var o=0;o<s.length;o++){var p=(s[o].substring(1)).toLowerCase(),w=new RegExp(t+x,"g"),y=((l.toLowerCase()).match(w));if(x.indexOf(p)!=-1&&y===null&&s.indexOf(t+n[d.key].toLowerCase())==-1){return true}}}}},j=function(r,n){var s=this.query,l=this.$element[0].selectionStart,p;for(p=l;p>=0;p--){if(s[p]==n){break}}var o=s.substring(p,l),q=s.substring(0,p),m=s.substring(l),s=q+n+r+m;this.tempQuery=s;return s},g=function(o){if(o.length&&d.sensitive){var n=b(this.query,this.$element[0].selectionStart).substring(1),r,m=o.length,q={highest:[],high:[],med:[],low:[]},l=[];if(n.length==1){for(r=0;r<m;r++){var s=o[r];if((s[d.key][0]==n)){q.highest.push(s)}else{if((s[d.key][0].toLowerCase()==n.toLowerCase())){q.high.push(s)}else{if(s[d.key].indexOf(n)!=-1){q.med.push(s)}else{q.low.push(s)}}}}for(r in q){var p;for(p in q[r]){l.push(q[r][p])}}return l}}return o},h=function(i){var l=this;i=a(i).map(function(n,o){n=a(l.options.item).attr("data-value",o[d.key]);var m=a("<div />");if(o[d.image]){m.append('<img class="mention_image" src="'+o[d.image]+'">')}if(o[d.name]){m.append('<b class="mention_name">'+o[d.name]+"</b>")}if(o[d.key]){m.append('<span class="mention_username"> '+(o.delimiter?o.delimiter:d.delimiter)+o[d.key]+"</span>")}n.find("a").attr("data-delimiter",(o.delimiter?o.delimiter:d.delimiter)).html(l.highlighter(m.html()));return n[0]});i.first().addClass("active");this.$menu.html(i);return this};if(d.delimiters.length==0){d.delimiters=d.delimiter;for(var e=0;e<d.users.length;e++){if(d.users[e].delimiter){if(d.delimiters.indexOf(d.users[e].delimiter)==-1){d.delimiters+=d.users[e].delimiter}}}}a.fn.typeahead.Constructor.prototype.render=h;a.fn.typeahead.Constructor.prototype.select=function(){var l=this.$menu.find(".active").attr("data-value"),i=this.$menu.find(".active").find("a").attr("data-delimiter");this.$element.val(this.updater(l,i)).change();return this.hide()};a.fn.typeahead.Constructor.prototype.updater=function(l,i){return l};return this.each(function(){var i=a(this);if(c()){i.typeahead(a.extend({source:d.users,matcher:f,updater:j,sorter:g},d.typeaheadOpts))}})}})})(jQuery);